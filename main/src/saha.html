

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Saha Ionization Model &#8212; Athelas v25.10 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'src/saha';</script>
    <link rel="canonical" href="https://athelas-astro.github.io/athelas/src/saha.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to Use Sphinx for Writing Docs" href="sphinx-doc.html" />
    <link rel="prev" title="Engines" href="engines.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Athelas v25.10 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="building.html">Building</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="engines.html">Engines</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Saha Ionization Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphinx-doc.html">How to Use Sphinx for Writing Docs</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/src/saha.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Saha Ionization Model</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numerical-methods">Numerical Methods</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linear">Linear</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#log">Log</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#atomic-data">Atomic Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input-deck">Input Deck</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="saha-ionization-model">
<h1>Saha Ionization Model<a class="headerlink" href="#saha-ionization-model" title="Permalink to this heading">#</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Athelas</span></code> models ionization equilibrium with the non-degenerate Saha-Boltzmann
equations based on the formalism of <a class="reference external" href="https://iopscience.iop.org/article/10.1088/0022-3727/33/8/314/pdf">Zaghloul</a> et al. (2000).
This model is used to compute ionization fractions and the mean charge state of
each atomic species. The ionization state enters the equation of state
through contributions to the internal energy and pressure and is therefore
solved repeatedly as part of the temperature inversion.
It is a large computational expense.</p>
<p>The Saha-Boltzmann equations have the form</p>
<div class="math notranslate nohighlight" id="equation-saha">
<span class="eqno">(1)<a class="headerlink" href="#equation-saha" title="Permalink to this equation">#</a></span>\[\frac{n_{s+1}n_{e}}{n_s} =
\frac{2 g_{s+1}}{g_s}
\left[ \frac{2 \pi m_e k_B T}{h^2} \right]^{3/2}
e^{-\chi_s/(k_B T)}, \,\,
s = 0, 1, ..., \mathbb{Z} - 1\]</div>
<p>where <span class="math notranslate nohighlight">\(n_s\)</span> is the number density of atoms in the <span class="math notranslate nohighlight">\(s\)</span>-th ionization state,
<span class="math notranslate nohighlight">\(g_s\)</span> is the associated statistical weight, <span class="math notranslate nohighlight">\(m_e\)</span> is the electron rest mass,
<span class="math notranslate nohighlight">\(h\)</span> is Planck’s constant,
<span class="math notranslate nohighlight">\(k_B\)</span> is Boltzmann’s constant, <span class="math notranslate nohighlight">\(\chi_s\)</span> is the ionization energy for the
<span class="math notranslate nohighlight">\(s \to (s+1)\)</span> process, and <span class="math notranslate nohighlight">\(\mathbb{Z}\)</span> is the atomic number of the species.</p>
<p>The Saha-Boltzmann equations can be combined with the condition of charge neutrality</p>
<div class="math notranslate nohighlight" id="equation-charge-neutrality">
<span class="eqno">(2)<a class="headerlink" href="#equation-charge-neutrality" title="Permalink to this equation">#</a></span>\[\sum_{s=1}^{\mathbb{Z}} s\, n_s = n_e\]</div>
<p>and conservation of nuclei</p>
<div class="math notranslate nohighlight" id="equation-nuclei">
<span class="eqno">(3)<a class="headerlink" href="#equation-nuclei" title="Permalink to this equation">#</a></span>\[\sum_{i=0}^{\mathbb{Z}} n_i = n_k = \text{constant},\]</div>
<p>where <span class="math notranslate nohighlight">\(n_k\)</span> is the number density of nuclei of species <span class="math notranslate nohighlight">\(k\)</span>,
and formed into a single set of transcendental equations that can be solved
for the mean charge <span class="math notranslate nohighlight">\(\bar{\mathbb{Z}}\)</span>. Let us denote the fraction of atoms
in the <span class="math notranslate nohighlight">\(s\)</span>-th ionization state as <span class="math notranslate nohighlight">\(y_s = n_s/n_k\)</span> and express the
mean charge as <span class="math notranslate nohighlight">\(\bar{\mathbb{Z}} = n_e/n_k\)</span> we can,
following <a class="reference external" href="https://iopscience.iop.org/article/10.1088/0022-3727/33/8/314/pdf">Zaghloul</a> , reexpress the above equations in the following forms</p>
<div class="math notranslate nohighlight" id="equation-conservation">
<span class="eqno">(4)<a class="headerlink" href="#equation-conservation" title="Permalink to this equation">#</a></span>\[\sum_{s=0}^{\mathbb{Z}} y_s = 1\]</div>
<div class="math notranslate nohighlight" id="equation-charge">
<span class="eqno">(5)<a class="headerlink" href="#equation-charge" title="Permalink to this equation">#</a></span>\[\sum_{s=0}^{\mathbb{Z}} s\, y_s = \bar{\mathbb{Z}}\]</div>
<div class="math notranslate nohighlight" id="equation-new-saha">
<span class="eqno">(6)<a class="headerlink" href="#equation-new-saha" title="Permalink to this equation">#</a></span>\[\frac{y_{s+1}\bar{\mathbb{Z}}n_{k}}{y_s} =
2\frac{g_{s+1}}{g_s}
\left[ \frac{2 \pi m_e k_B T}{h^2} \right]^{3/2}
e^{-\chi_s/(k_B T)} = f_{s+1}, \,\,
s = 0, 1, ..., \mathbb{Z} - 1\]</div>
<p>and observe the recurrence relation</p>
<div class="math notranslate nohighlight" id="equation-y">
<span class="eqno">(7)<a class="headerlink" href="#equation-y" title="Permalink to this equation">#</a></span>\[y_{s+1} = y_s \frac{f_{s+1}}{\bar{\mathbb{Z}}n_k}.\]</div>
<p>Substituting this into <a class="reference internal" href="#equation-charge">(5)</a> we get
an expression for the neutral fraction</p>
<div class="math notranslate nohighlight" id="equation-y0">
<span class="eqno">(8)<a class="headerlink" href="#equation-y0" title="Permalink to this equation">#</a></span>\[y_0 = \bar{\mathbb{Z}}
\left[ \sum_{s=1}^{\mathbb{Z}} \frac{s\prod_{j=1}^{s} f_j}{(\bar{\mathbb{Z}} n_k)^s} \right].\]</div>
<p>Finally, combining the relations for the ionization fractions <span class="math notranslate nohighlight">\(y\)</span> with the
condition for conservation <a class="reference internal" href="#equation-conservation">(4)</a> of nuclei we
arrive at a transcendental equation for <span class="math notranslate nohighlight">\(\bar{\mathbb{Z}}\)</span></p>
<div class="math notranslate nohighlight" id="equation-saha-eq">
<span class="eqno">(9)<a class="headerlink" href="#equation-saha-eq" title="Permalink to this equation">#</a></span>\[F(\bar{\mathbb{Z}}) = 1 - \bar{\mathbb{Z}}_k
\left[
  \sum_{s=1}^{Z_k}
  \frac{
    s \displaystyle\prod_{j=1}^{s} f_{k,j}
  }{
    (\bar{\mathbb{Z}}_k n_k)^s
  }
\right]^{-1}
\left[
  1 + \sum_{s=1}^{Z_k}
  \frac{
    \displaystyle\prod_{j=1}^{i} f_{k,j}
  }{
    (\bar{\mathbb{Z}}_k n_k)^s
  }
\right]\]</div>
<p>Equation <a class="reference internal" href="#equation-saha-eq">(9)</a> may be solved iteratively for <span class="math notranslate nohighlight">\(\bar{\mathbb{Z}}\)</span> using a any
root finding algorithm. <code class="docutils literal notranslate"><span class="pre">Athelas</span></code> implements a couple of method for finding
<span class="math notranslate nohighlight">\(\bar{\mathbb{Z}}\)</span>.</p>
<p>Once <span class="math notranslate nohighlight">\(\bar{\mathbb{Z}}\)</span> is known then the constribution from this species
to the electron number density can be tallied as <span class="math notranslate nohighlight">\(n_e = \bar{\mathbb{Z}}n_k\)</span>.</p>
<section id="numerical-methods">
<h2>Numerical Methods<a class="headerlink" href="#numerical-methods" title="Permalink to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Athelas</span></code> implements two methods for solving equation <a class="reference internal" href="#equation-saha-eq">(9)</a>.
Both solvers use a Newton-Raphson iteration so derivatives are necessary.
The first, which we refer to as the <code class="docutils literal notranslate"><span class="pre">linear</span></code> model solves Eq. <a class="reference internal" href="#equation-saha-eq">(9)</a>
directly. The second, referred to as <code class="docutils literal notranslate"><span class="pre">log</span></code> in <code class="docutils literal notranslate"><span class="pre">Athelas</span></code>, reformaulates
Eq. <a class="reference internal" href="#equation-saha-eq">(9)</a> by taking natural logs and expressing <span class="math notranslate nohighlight">\(\prod f\)</span> as
exponentials.</p>
<p>The linear Saha solver is faster but can be numerically fragile
for large <span class="math notranslate nohighlight">\(\mathbb{Z}\)</span> and intended for light elements.
For the simulations that <code class="docutils literal notranslate"><span class="pre">Athelas</span></code> is designed to carry out
this is usually fine – it is stable through CNO. The logarithmic
solver is robust for all species and thermodynamic conditions,
at increased cost.</p>
<section id="linear">
<h3>Linear<a class="headerlink" href="#linear" title="Permalink to this heading">#</a></h3>
<p>The original Saha solver in <code class="docutils literal notranslate"><span class="pre">Athelas</span></code>, which we refer to as <code class="docutils literal notranslate"><span class="pre">linear</span></code>,
solves Eq <a class="reference internal" href="#equation-saha-eq">(9)</a> directly using a Newton-Raphson iteration.
Before writing down the derivative <span class="math notranslate nohighlight">\(F'(\mathbb{\bar{Z}})\)</span> we note that
this formulation can be subject to numerical instabilities. An attempt to
circumvent this, inspired by the implementation in <code class="docutils literal notranslate"><span class="pre">SNEC</span></code>, is to introduce thresholds on
prospective electron number densities such that they are ignored. This serves
both as a guard to instability and improves performance.
We rewrite Eqs <a class="reference internal" href="#equation-saha-eq">(9)</a> and <a class="reference internal" href="#equation-y0">(8)</a> as</p>
<div class="math notranslate nohighlight" id="equation-src-saha-0">
<span class="eqno">(10)<a class="headerlink" href="#equation-src-saha-0" title="Permalink to this equation">#</a></span>\[y_{\rm min} = \bar{\mathbb{Z}}
\left[ s_{\rm min} - 1 + \sum_{s=s_{\rm min}}^{s_{\rm max}}
\frac{s\prod_{j=s_{\rm min}}^{s} f_j}{(\bar{\mathbb{Z}} n_k)^s} \right].\]</div>
<div class="math notranslate nohighlight" id="equation-src-saha-1">
<span class="eqno">(11)<a class="headerlink" href="#equation-src-saha-1" title="Permalink to this equation">#</a></span>\[F(\bar{\mathbb{Z}}) = 1 - \bar{\mathbb{Z}}_k
\left[
  s_{\rm min} - 1 +
  \sum_{s=s_{\rm min}}^{s_{\rm max}}
  \frac{
    s \displaystyle\prod_{j=s_{\rm min}}^{s} f_{k,j}
  }{
    (\bar{\mathbb{Z}}_k n_k)^s
  }
\right]^{-1}
\left[
  1 + \sum_{s=s_{\rm min}}^{s_{\rm max}}
  \frac{
    \displaystyle\prod_{j=1}^{i} f_{k,j}
  }{
    (\bar{\mathbb{Z}}_k n_k)^s
  }
\right]\]</div>
<p><span class="math notranslate nohighlight">\(s_{\rm min}\)</span> and <span class="math notranslate nohighlight">\(s_{\rm max}\)</span> are set based on thresholds
<code class="docutils literal notranslate"><span class="pre">ZBARTOL</span></code> and <code class="docutils literal notranslate"><span class="pre">ZBARTOLINV</span></code> as compared to <span class="math notranslate nohighlight">\(f_s/(\bar{\mathbb{Z}} n_k)\)</span>.
If <span class="math notranslate nohighlight">\(f_s/(\bar{\mathbb{Z}} n_k) &lt;\)</span> <code class="docutils literal notranslate"><span class="pre">ZBARTOL</span></code> then we do not solve for the
<span class="math notranslate nohighlight">\((s+1)\)</span>-th ionization state and assume that state and all following are empty.
Similarly, if <span class="math notranslate nohighlight">\(f_s/(\bar{\mathbb{Z}} n_k) &gt;\)</span> <code class="docutils literal notranslate"><span class="pre">ZBARTOLINV</span></code> we assume that the
<span class="math notranslate nohighlight">\(s\)</span>-th ionization state and all preceeding are empty.</p>
<p>With this in hand we may write down the derivative <span class="math notranslate nohighlight">\(F'(\bar{\mathbb{Z}})\)</span></p>
<div class="math notranslate nohighlight" id="equation-src-saha-2">
<span class="eqno">(12)<a class="headerlink" href="#equation-src-saha-2" title="Permalink to this equation">#</a></span>\[F'(\bar{\mathbb{Z}}) = \left[ \Sigma_1 -
\left( 1 + \Sigma_0 \right)
\left[ 1 + \Sigma_3(s_{\rm min} - 1 + \Sigma_1)^{-1} \right]
\right] (s_{\rm min} - 1 + \Sigma_1)\]</div>
<p>where we have defined</p>
<div class="math notranslate nohighlight" id="equation-src-saha-3">
<span class="eqno">(13)<a class="headerlink" href="#equation-src-saha-3" title="Permalink to this equation">#</a></span>\[\begin{split}\begin{aligned}
\Sigma_0 &amp;= \sum_{s=s_{\rm min}}^{s=s_{\rm max}}
  \left( \prod_{j=s_{\rm min}}^{s} \frac{f_j}{\bar{\mathcal{Z}}n_k}\right) \\
\Sigma_1 &amp;= \sum_{s=s_{\rm min}}^{s=s_{\rm max}}
  \left( s\prod_{j=s_{\rm min}}^{s}
\frac{f_j}{\bar{\mathcal{Z}}n_k}\right) \\
\Sigma_2 &amp;= \sum_{s=s_{\rm min}}^{s=s_{\rm max}}
  \left( (s-s_{\rm min} + 1)\prod_{j=s_{\rm min}}^{s}
\frac{f_j}{\bar{\mathcal{Z}}n_k}\right) \\
\Sigma_3 &amp;= \sum_{s=s_{\rm min}}^{s=s_{\rm max}}
  \left( s(s-s_{\rm min} + 1)\prod_{j=s_{\rm min}}^{s}
\frac{f_j}{\bar{\mathcal{Z}}n_k}\right)
\end{aligned}\end{split}\]</div>
</section>
<section id="log">
<h3>Log<a class="headerlink" href="#log" title="Permalink to this heading">#</a></h3>
<p>The products of exponentials in Eq. <a class="reference internal" href="#equation-saha-eq">(9)</a> can overflow for sufficiently
high-<span class="math notranslate nohighlight">\(\mathbb{Z}\)</span> atoms.
To improve numerical stability, Athelas can express the Saha ladder in logarithmic
space. Begin by compactifying Eq <a class="reference internal" href="#equation-saha-eq">(9)</a> as</p>
<div class="math notranslate nohighlight" id="equation-src-saha-4">
<span class="eqno">(14)<a class="headerlink" href="#equation-src-saha-4" title="Permalink to this equation">#</a></span>\[F(\bar{\mathbb{Z}}) = 1 - \bar{\mathbb{Z}}\frac{\mathcal{N}}{\mathcal{D}}\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathcal{N}\)</span> and <span class="math notranslate nohighlight">\(\mathcal{D}\)</span> can be identified from
Eq <a class="reference internal" href="#equation-saha-eq">(9)</a>.
Taking the natural logarithm of <span class="math notranslate nohighlight">\(F(\bar{\mathbb{Z}})\)</span> and rearranging,
we notice that a root of <span class="math notranslate nohighlight">\(F\)</span> corresponds to a root of</p>
<div class="math notranslate nohighlight" id="equation-src-saha-5">
<span class="eqno">(15)<a class="headerlink" href="#equation-src-saha-5" title="Permalink to this equation">#</a></span>\[G(\bar{\mathbb{Z}}) = \ln \bar{\mathbb{Z}} + \ln \mathcal{N} - \ln \mathcal{D}\]</div>
<p>In what follows we will exploit the “LogSumExp” trick borrowed from
machine learning. The core idea is to notice that</p>
<div class="math notranslate nohighlight" id="equation-src-saha-6">
<span class="eqno">(16)<a class="headerlink" href="#equation-src-saha-6" title="Permalink to this equation">#</a></span>\[\ln \left( \sum_i e^{a_i} \right)
= a_{\rm max} + \ln \left( \sum_i e^{a_i - a_{\rm max}} \right).\]</div>
<p>All that remains is to express <span class="math notranslate nohighlight">\(\mathcal{N}\)</span> and <span class="math notranslate nohighlight">\(\mathcal{D}\)</span>
in a useful form. Note that the above can be written into an
inline algorithm that doesn’t require a-priori knowledge of
<span class="math notranslate nohighlight">\(a_{\rm max}\)</span>.</p>
<p>We define</p>
<div class="math notranslate nohighlight" id="equation-src-saha-7">
<span class="eqno">(17)<a class="headerlink" href="#equation-src-saha-7" title="Permalink to this equation">#</a></span>\[\ell_i = \ln f_i, \quad
L_i = \sum_{j=0}^{i-1} \ell_j = \ln F_i.\]</div>
<p>The transcendental equation for <span class="math notranslate nohighlight">\(\bar{\mathbb{Z}}\)</span> is rewritten in terms of
<span class="math notranslate nohighlight">\(x = \ln \bar{\mathbb{Z}}\)</span>. Defining the sums</p>
<div class="math notranslate nohighlight" id="equation-src-saha-8">
<span class="eqno">(18)<a class="headerlink" href="#equation-src-saha-8" title="Permalink to this equation">#</a></span>\[\begin{split}\mathcal{N}(x) = \sum_{i=1}^{Z} \exp\left(L_i - i(x - \ln n_k)\right), \\
\mathcal{D}(x) = \sum_{i=1}^{Z} i \exp\left(L_i - i(x - \ln n_k)\right).\end{split}\]</div>
<p>With manipulation these can be identified as the numerator and denominator of
Eq <a class="reference internal" href="#equation-saha-eq">(9)</a>. The mean charge equation then becomes</p>
<div class="math notranslate nohighlight" id="equation-src-saha-9">
<span class="eqno">(19)<a class="headerlink" href="#equation-src-saha-9" title="Permalink to this equation">#</a></span>\[G(x) = x + \ln \mathcal{N}(x) - \ln \mathcal{D}(x).\]</div>
<p>This form avoids explicit products and powers of <span class="math notranslate nohighlight">\(\bar{\mathbb{Z}}\)</span>,
and all summations are evaluated using stable log-sum-exp techniques.
The equation <span class="math notranslate nohighlight">\(G(x) = 0\)</span> is solved using a Newton–Raphson iteration in logarithmic
space. This requires the derivative which, with respect to <span class="math notranslate nohighlight">\(x\)</span>, can easily be
written down:</p>
<div class="math notranslate nohighlight" id="equation-src-saha-10">
<span class="eqno">(20)<a class="headerlink" href="#equation-src-saha-10" title="Permalink to this equation">#</a></span>\[G'(x) = 1 - \frac{\mathcal{D}(x)}{\mathcal{N}(x)}
+ \frac{\mathcal{E}(x)}{\mathcal{D}(x)},\]</div>
<p>where</p>
<div class="math notranslate nohighlight" id="equation-src-saha-11">
<span class="eqno">(21)<a class="headerlink" href="#equation-src-saha-11" title="Permalink to this equation">#</a></span>\[\mathcal{E}(x) = \sum_{i=1}^{Z} i^2 \exp\left(L_i - i(x - \ln n_k)\right).\]</div>
<p>Then we may recover <span class="math notranslate nohighlight">\(\bar{\mathbb{Z}} = e^{x}\)</span>.
The iteration typically converges in one or two steps.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The minimum/maximum ionization state tricks used above in the <code class="docutils literal notranslate"><span class="pre">linear</span></code>
solver are not yet implemented in the <code class="docutils literal notranslate"><span class="pre">log</span></code> solver.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>We recommend the <code class="docutils literal notranslate"><span class="pre">linear</span></code> solver for most use cases. It is slightly
faster and stable for most species of concern in the context of
supernova ejecta.</p>
</div>
</section>
</section>
<section id="atomic-data">
<h2>Atomic Data<a class="headerlink" href="#atomic-data" title="Permalink to this heading">#</a></h2>
<p>We take ionization potentials and statistical weights from the NIST database.
Ionization potentials are stored in <code class="docutils literal notranslate"><span class="pre">athelas/data/atomic_data_ionization.dat</span></code>
and statistical weights in <code class="docutils literal notranslate"><span class="pre">athelas/data/atomic_data_degeneracy_factors.dat</span></code>.
These are provided for convenience but the user can supply their own.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>We assume, as is common, that the ground states are the dominant
contributors in the Saha-Boltzmann equation. Therefore, there is no
temperature dependence in the partition functions and we
simply use the ground state statistical weights.</p>
</div>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ionization</span></code> physics has a few controls in the <code class="docutils literal notranslate"><span class="pre">[ionization]</span></code> block.
The paths to the ionization potentials and degeneracy factors must
be specified. The provided data are stored in <code class="docutils literal notranslate"><span class="pre">athelas/data</span></code> and can be set
with <code class="docutils literal notranslate"><span class="pre">fn_ionization</span></code> and <code class="docutils literal notranslate"><span class="pre">fn_degeneracy</span></code>. These are required when
ionization is enabled. Then, the number of species to solve Saha ionization for
may be set with the <code class="docutils literal notranslate"><span class="pre">ncomps</span></code> option. Finally, the solver method may be set
as <code class="docutils literal notranslate"><span class="pre">solver</span> <span class="pre">=</span> <span class="pre">linear</span></code> or <code class="docutils literal notranslate"><span class="pre">solver</span> <span class="pre">=</span> <span class="pre">log</span></code>.</p>
<p>As is inferred above, we do not require that we do Saha ionization solves
for all species present on the domain. Instead, we can do ionization for
any number of species.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We currently assume full ionization for species which
we do not do Saha solves. This can be extended with little work
if desired.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The number of Saha species must be less than or equal
to the total number of species set in the <code class="docutils literal notranslate"><span class="pre">composition</span></code> block.
If neutrons are present in the compositional profile then this
inequality is strict.</p>
</div>
</section>
<section id="input-deck">
<h2>Input Deck<a class="headerlink" href="#input-deck" title="Permalink to this heading">#</a></h2>
<p>Ionization is controlled in the input deck as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">physics</span><span class="p">]</span>
<span class="n">ionization</span> <span class="o">=</span> <span class="n">true</span>

<span class="p">[</span><span class="n">ionization</span><span class="p">]</span>
<span class="n">fn_ionization</span> <span class="o">=</span> <span class="s2">&quot;../data/atomic_data_ionization.dat&quot;</span> <span class="p">[</span><span class="n">Required</span><span class="p">]</span>
<span class="n">fn_degeneracy</span> <span class="o">=</span> <span class="s2">&quot;../data/atomic_data_degeneracy_factors.dat&quot;</span> <span class="p">[</span><span class="n">Required</span><span class="p">]</span>
<span class="n">ncomps</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># must be &lt;= [composition.ncomps] !! [Required]</span>
<span class="n">solver</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span> <span class="c1"># or &quot;log&quot; [Optional]</span>
</pre></div>
</div>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="engines.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Engines</p>
      </div>
    </a>
    <a class="right-next"
       href="sphinx-doc.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">How to Use Sphinx for Writing Docs</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#numerical-methods">Numerical Methods</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linear">Linear</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#log">Log</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#atomic-data">Atomic Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input-deck">Input Deck</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Brandon L. Barker
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>